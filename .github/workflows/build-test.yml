name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: ${{ matrix.os }} (${{ matrix.build-type }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        build-type: [Debug, Release]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup build environment (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
        
    - name: Setup build environment (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install cmake
        
    - name: Verify tools
      run: |
        cmake --version
        c++ --version
        
    - name: Configure project
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build-type }}
        
    - name: Build project
      run: |
        cd build
        cmake --build . --parallel 2
        
    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure --verbose
      
    - name: Generate coverage report (Ubuntu Debug only)
      if: matrix.os == 'ubuntu-latest' && matrix.build-type == 'Debug'
      run: |
        cd build
        sudo apt-get install -y gcovr
        gcovr -r .. --txt
        echo "✅ Coverage report generated (output above)"

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck build-essential cmake
        
    - name: Run static analysis
      run: |
        echo "=== Running Cppcheck ==="
        cppcheck --enable=warning,style,performance,portability \
                 --suppress=missingInclude \
                 --quiet \
                 src/ include/
        echo "✅ Static analysis completed"
        
    - name: Setup project for clang-tidy
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        
    - name: Run clang-tidy (optional)
      continue-on-error: true
      run: |
        cd build
        if command -v clang-tidy >/dev/null 2>&1; then
          echo "=== Running clang-tidy ==="
          clang-tidy ../src/*.cpp -p .
        else
          echo "clang-tidy not available, skipping"
        fi

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
        
    - name: Build Release version
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        cmake --build . --parallel 2
        
    - name: Run integration tests
      run: |
        cd build
        echo "=== Running basic functionality test ==="
        timeout 10s bash -c 'echo -e "1\nTest Task\n4\n0\n" | ./todoapp' || true
        
        echo "=== Verifying executable ==="
        file ./todoapp
        ldd ./todoapp || true
        
    - name: Create release package
      if: github.ref == 'refs/heads/main'
      run: |
        mkdir -p release
        cp build/todoapp release/
        cp README.md LICENSE release/ 2>/dev/null || true
        cd release && tar -czf ../todoapp-release.tar.gz .
        echo "✅ Release package created: todoapp-release.tar.gz"
        ls -la ../todoapp-release.tar.gz