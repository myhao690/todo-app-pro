name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: 构建和测试
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        build-type: [Debug, Release]
        
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 安装CMake (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        # 安装最新CMake
        wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | sudo apt-key add -
        echo 'deb https://apt.kitware.com/ubuntu/ focal main' | sudo tee /etc/apt/sources.list.d/kitware.list >/dev/null
        sudo apt-get update
        sudo apt-get install -y cmake
        
    - name: 安装依赖 (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew update
        brew install cmake
        
    - name: 验证CMake版本
      run: cmake --version
        
    - name: 配置CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build-type }}
        
    - name: 构建项目
      run: |
        cd build
        cmake --build . --config ${{ matrix.build-type }} --parallel
        
    - name: 运行测试
      run: |
        cd build
        ctest --output-on-failure --verbose
        
    - name: 上传测试结果
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.build-type }}
        path: build/Testing/
        
    - name: 运行代码覆盖率 (Ubuntu Debug)
      if: matrix.os == 'ubuntu-latest' && matrix.build-type == 'Debug'
      run: |
        sudo apt-get install -y gcovr
        cd build
        gcovr -r .. --html --html-details -o coverage.html
        
    - name: 上传覆盖率报告
      uses: actions/upload-artifact@v4
      if: matrix.os == 'ubuntu-latest' && matrix.build-type == 'Debug'
      with:
        name: coverage-report
        path: build/coverage.html

  static-analysis:
    name: 静态代码分析
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 安装分析工具
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-tidy build-essential cmake
        
    - name: 配置项目
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        
    - name: 运行Cppcheck
      run: |
        cppcheck --enable=warning,style,performance,portability --error-exitcode=0 --suppress=missingInclude src/ include/
        
    - name: 运行clang-tidy (可选失败)
      continue-on-error: true
      run: |
        cd build
        clang-tidy ../src/*.cpp -p .

  release:
    name: 创建发布版本
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
        
    - name: 构建发布版本
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        cmake --build . --parallel
        
    - name: 创建发布包
      run: |
        mkdir -p release
        cp build/todoapp release/
        cp README.md LICENSE release/
        tar -czf todoapp-release.tar.gz -C release .
        
    - name: 上传发布产物
      uses: actions/upload-artifact@v4
      with:
        name: todoapp-release
        path: todoapp-release.tar.gz