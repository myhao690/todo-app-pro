name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: 构建和测试
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        build-type: [Debug, Release]
        
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置环境 (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
        
    - name: 设置环境 (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install cmake
        
    - name: 验证工具版本
      run: |
        cmake --version
        c++ --version
        
    - name: 创建构建目录
      run: mkdir -p build
        
    - name: 配置CMake
      working-directory: build
      run: cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build-type }}
        
    - name: 编译项目
      working-directory: build
      run: cmake --build . --parallel 2
        
    - name: 运行单元测试
      working-directory: build
      run: ctest --output-on-failure --verbose
      
    - name: 生成覆盖率报告 (Ubuntu Debug only)
      if: matrix.os == 'ubuntu-latest' && matrix.build-type == 'Debug'
      working-directory: build
      run: |
        sudo apt-get install -y gcovr
        gcovr -r .. --txt
        gcovr -r .. --html --html-details -o coverage.html
        
    - name: 上传覆盖率报告
      if: matrix.os == 'ubuntu-latest' && matrix.build-type == 'Debug'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-${{ github.run_number }}
        path: build/coverage.html
        retention-days: 30

  code-quality:
    name: 代码质量检查
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 安装工具
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck build-essential cmake
        
    - name: 运行静态分析
      run: |
        echo "=== 运行 Cppcheck ==="
        cppcheck --enable=warning,style,performance,portability \
                 --suppress=missingInclude \
                 --quiet \
                 src/ include/
        
    - name: 配置项目 (为clang-tidy准备)
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        
    - name: 运行 clang-tidy (可选)
      continue-on-error: true
      working-directory: build
      run: |
        if command -v clang-tidy >/dev/null 2>&1; then
          echo "=== 运行 clang-tidy ==="
          clang-tidy ../src/*.cpp -p .
        else
          echo "clang-tidy 未安装，跳过检查"
        fi

  integration-test:
    name: 集成测试
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
        
    - name: 构建Release版本
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        cmake --build . --parallel 2
        
    - name: 运行集成测试
      run: |
        cd build
        echo "=== 运行基本功能测试 ==="
        timeout 10s bash -c 'echo -e "1\n测试任务\n4\n0\n" | ./todoapp' || true
        
        echo "=== 验证可执行文件 ==="
        file ./todoapp
        ldd ./todoapp || true
        
    - name: 创建发布包
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        mkdir -p release
        cp build/todoapp release/
        cp README.md LICENSE release/ 2>/dev/null || true
        cd release && tar -czf ../todoapp-release.tar.gz .
        
    - name: 上传发布包
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: actions/upload-artifact@v4
      with:
        name: todoapp-release-${{ github.run_number }}
        path: todoapp-release.tar.gz
        retention-days: 90