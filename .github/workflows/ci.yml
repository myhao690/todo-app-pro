name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: 构建和测试
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        build-type: [Debug, Release]
        
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 安装依赖 (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential
        
    - name: 安装依赖 (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install cmake
        
    - name: 配置CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build-type }}
        
    - name: 构建项目
      run: |
        cmake --build build --config ${{ matrix.build-type }}
        
    - name: 运行测试
      run: |
        cd build
        ctest --output-on-failure --verbose
        
    - name: 上传测试结果
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.build-type }}
        path: build/Testing/
        
    - name: 运行代码覆盖率 (Ubuntu Debug)
      if: matrix.os == 'ubuntu-latest' && matrix.build-type == 'Debug'
      run: |
        sudo apt-get install -y gcovr
        gcovr -r . --html --html-details -o build/coverage.html
        
    - name: 上传覆盖率报告
      uses: actions/upload-artifact@v3
      if: matrix.os == 'ubuntu-latest' && matrix.build-type == 'Debug'
      with:
        name: coverage-report
        path: build/coverage.html

  static-analysis:
    name: 静态代码分析
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 安装工具
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-tidy
        
    - name: 运行Cppcheck
      run: |
        cppcheck --enable=all --error-exitcode=1 --suppress=missingInclude src/ include/
        
    - name: 运行clang-tidy
      run: |
        cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        clang-tidy src/*.cpp -p build/

  release:
    name: 创建发布版本
    runs-on: ubuntu-latest
    needs: [test, static-analysis]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 构建发布版本
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build
        
    - name: 创建发布包
      run: |
        mkdir -p release
        cp build/todoapp release/
        cp README.md LICENSE release/
        tar -czf todoapp-release.tar.gz -C release .
        
    - name: 上传发布产物
      uses: actions/upload-artifact@v3
      with:
        name: todoapp-release
        path: todoapp-release.tar.gz